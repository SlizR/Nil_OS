name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  quality-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - run: |
          mkdir -p .github/workflows
          echo "CODE QUALITY REPORT" > .github/workflows/log.txt
          echo "===================" >> .github/workflows/log.txt
          echo "" >> .github/workflows/log.txt

          echo "SHELLCHECK RESULTS:" >> .github/workflows/log.txt
          echo "-------------------" >> .github/workflows/log.txt
          find nil -type f -name "*.sh" -exec shellcheck {} + >> .github/workflows/log.txt 2>&1 || true
          echo "" >> .github/workflows/log.txt

          echo "VBSCRIPT RESULTS:" >> .github/workflows/log.txt
          echo "-----------------" >> .github/workflows/log.txt
          find nil -type f -name "*.vbs" -exec grep -L "Option Explicit" {} + >> .github/workflows/log.txt 2>&1 || true
          echo "" >> .github/workflows/log.txt

          echo "END OF REPORT" >> .github/workflows/log.txt

      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add nil .github/workflows/log.txt
          git diff --cached --quiet || git commit -m "Code quality report"

      - uses: peter-evans/create-pull-request@v6
        with:
          branch: code-quality-report
          title: Code Quality Report
          body: |
            Automated code quality analysis.
